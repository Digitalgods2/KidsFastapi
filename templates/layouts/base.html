<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Digital Gods - KidsKlassiks AI Story Transformer{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg">
    <link rel="alternate icon" href="/static/images/digital-gods-logo.png">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link href="/static/css/style.css" rel="stylesheet">
    <!-- Digital Gods Enhanced Styles -->
    <link href="/static/css/digital-gods-style.css?v=3" rel="stylesheet">
    <!-- PhotoSwipe CSS for advanced image viewer -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@5/dist/photoswipe.css">
    
    <!-- Theme Styles -->
    <style>
        /* Theme Switcher Icon Styling */
        #themeToggle {
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        #themeToggle:hover {
            transform: scale(1.1);
        }
        
        #themeIcon {
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        
        /* System Theme (uses Bootstrap default or dark based on system preference) */
        .theme-system {
            /* No additional styles - uses Bootstrap's built-in theming */
        }
        
        /* Pure Dark Theme - True black background */
        .theme-dark {
            --bs-body-bg: #000000;
            --bs-body-color: #ffffff;
            --bs-card-bg: #111111;
            --bs-border-color: #333333;
            --bs-link-color: #58a6ff;
            --bs-link-hover-color: #79c0ff;
            background-color: #000000 !important;
        }
        
        .theme-dark .card {
            background-color: #111111;
            border-color: #333333;
        }
        
        .theme-dark .navbar {
            background-color: #000000 !important;
            border-bottom: 1px solid #333333;
        }
        
        .theme-dark .modal-content {
            background-color: #111111;
            color: #ffffff;
        }
        
        .theme-dark .form-control,
        .theme-dark .form-select {
            background-color: #1a1a1a;
            border-color: #333333;
            color: #ffffff;
        }
        
        .theme-dark .form-control:focus,
        .theme-dark .form-select:focus {
            background-color: #1a1a1a;
            border-color: #555555;
            color: #ffffff;
        }
        
        .theme-dark .btn-outline-primary {
            color: #6ea8fe;
            border-color: #6ea8fe;
        }
        
        .theme-dark .btn-outline-primary:hover {
            background-color: #6ea8fe;
            color: #000000;
        }
        
        /* Enhanced text colors for dark theme */
        .theme-dark .text-muted {
            color: #b0b0b0 !important;
        }
        
        .theme-dark a:not(.btn):not(.nav-link):not(.dropdown-item) {
            color: #58a6ff;
            text-decoration: none;
        }
        
        .theme-dark a:not(.btn):not(.nav-link):not(.dropdown-item):hover {
            color: #79c0ff;
            text-decoration: underline;
        }
        
        .theme-dark footer {
            background-color: #0a0a0a !important;
            border-top: 1px solid #333333;
        }
        
        .theme-dark footer .text-muted {
            color: #b0b0b0 !important;
        }
        
        .theme-dark footer a {
            color: #58a6ff !important;
        }
        
        .theme-dark footer a:hover {
            color: #79c0ff !important;
        }
        
        /* Charcoal Theme - Dark gray background */
        .theme-charcoal {
            --bs-body-bg: #1a1a1a;
            --bs-body-color: #e0e0e0;
            --bs-card-bg: #2a2a2a;
            --bs-border-color: #404040;
            --bs-link-color: #6eb4ff;
            --bs-link-hover-color: #8fc9ff;
            background-color: #1a1a1a !important;
        }
        
        .theme-charcoal .card {
            background-color: #2a2a2a;
            border-color: #404040;
        }
        
        .theme-charcoal .navbar {
            background-color: #0d0d0d !important;
            border-bottom: 1px solid #404040;
        }
        
        .theme-charcoal .modal-content {
            background-color: #2a2a2a;
            color: #e0e0e0;
        }
        
        .theme-charcoal .form-control,
        .theme-charcoal .form-select {
            background-color: #353535;
            border-color: #404040;
            color: #e0e0e0;
        }
        
        .theme-charcoal .form-control:focus,
        .theme-charcoal .form-select:focus {
            background-color: #353535;
            border-color: #555555;
            color: #e0e0e0;
        }
        
        .theme-charcoal .btn-outline-primary {
            color: #8ab4f8;
            border-color: #8ab4f8;
        }
        
        .theme-charcoal .btn-outline-primary:hover {
            background-color: #8ab4f8;
            color: #1a1a1a;
        }
        
        /* Enhanced text colors for charcoal theme */
        .theme-charcoal .text-muted {
            color: #b8b8b8 !important;
        }
        
        .theme-charcoal a:not(.btn):not(.nav-link):not(.dropdown-item) {
            color: #6eb4ff;
            text-decoration: none;
        }
        
        .theme-charcoal a:not(.btn):not(.nav-link):not(.dropdown-item):hover {
            color: #8fc9ff;
            text-decoration: underline;
        }
        
        .theme-charcoal footer {
            background-color: #121212 !important;
            border-top: 1px solid #404040;
        }
        
        .theme-charcoal footer .text-muted {
            color: #b8b8b8 !important;
        }
        
        .theme-charcoal footer a {
            color: #6eb4ff !important;
        }
        
        .theme-charcoal footer a:hover {
            color: #8fc9ff !important;
        }
        
        /* Common dark theme adjustments */
        .theme-dark .dropdown-menu,
        .theme-charcoal .dropdown-menu {
            background-color: var(--bs-card-bg);
            border-color: var(--bs-border-color);
        }
        
        .theme-dark .dropdown-item,
        .theme-charcoal .dropdown-item {
            color: var(--bs-body-color);
        }
        
        .theme-dark .dropdown-item:hover,
        .theme-charcoal .dropdown-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .theme-dark .table,
        .theme-charcoal .table {
            --bs-table-bg: transparent;
            --bs-table-striped-bg: rgba(255, 255, 255, 0.05);
            --bs-table-hover-bg: rgba(255, 255, 255, 0.075);
            color: var(--bs-body-color);
        }
        
        .theme-dark .alert-info,
        .theme-charcoal .alert-info {
            background-color: rgba(13, 110, 253, 0.2);
            border-color: rgba(13, 110, 253, 0.3);
            color: #8ab4f8;
        }
        
        /* Enhanced contrast for badges and pills */
        .theme-dark .badge,
        .theme-charcoal .badge {
            color: #ffffff;
            font-weight: 600;
        }
        
        /* Better visibility for small text */
        .theme-dark small,
        .theme-charcoal small {
            color: #c0c0c0;
        }
        
        .theme-dark .small,
        .theme-charcoal .small {
            color: #c0c0c0;
        }
        
        /* Nav link enhancements for better visibility */
        .theme-dark .nav-link,
        .theme-charcoal .nav-link {
            color: rgba(255, 255, 255, 0.85) !important;
        }
        
        .theme-dark .nav-link:hover,
        .theme-charcoal .nav-link:hover {
            color: rgba(255, 255, 255, 1) !important;
        }
        
        /* Better contrast for status indicators */
        .theme-dark .text-success,
        .theme-charcoal .text-success {
            color: #4ade80 !important;
        }
        
        .theme-dark .text-danger,
        .theme-charcoal .text-danger {
            color: #f87171 !important;
        }
        
        .theme-dark .text-warning,
        .theme-charcoal .text-warning {
            color: #fbbf24 !important;
        }
        
        .theme-dark .text-info,
        .theme-charcoal .text-info {
            color: #60a5fa !important;
        }
        
        /* Fix alert-light visibility in dark themes */
        .theme-dark .alert-light,
        .theme-charcoal .alert-light,
        body.bg-dark .alert-light {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            color: #e0e0e0;
        }
        
        .theme-dark .alert-light .text-muted,
        .theme-charcoal .alert-light .text-muted,
        body.bg-dark .alert-light .text-muted {
            color: #b8b8b8 !important;
        }
        
        /* Ensure alert-light text is visible */
        body.bg-dark .alert-light small {
            color: #c0c0c0 !important;
        }
        
        /* Better alert-secondary styling for dark mode */
        body.bg-dark .alert-secondary {
            background-color: rgba(108, 117, 125, 0.2) !important;
            border-color: rgba(108, 117, 125, 0.4) !important;
            color: #d0d0d0 !important;
        }
        
        /* Ensure all small text in alerts is visible */
        body.bg-dark .alert small {
            color: #d0d0d0 !important;
            opacity: 1 !important;
        }
        
        /* Card content visibility improvements */
        body.bg-dark .card-body small {
            color: #c0c0c0 !important;
        }
        
        /* Library page specific fixes */
        body.bg-dark .book-card .text-muted {
            color: #a8a8a8 !important;
        }
        
        /* CRITICAL FIX: WHITE ON BLUE for ALL badges - MAXIMUM CONTRAST */
        body.bg-dark .badge.bg-light,
        body.bg-dark .badge.bg-secondary,
        body.bg-dark .badge.text-bg-secondary,
        body.bg-dark .badge.rounded-pill,
        body.bg-dark .badge {
            background-color: #1e3a5f !important;  /* Dark blue background */
            color: #ffffff !important;  /* Pure white text */
            border: 1px solid #4a7fb8 !important;  /* Light blue border */
            font-weight: 600 !important;
            opacity: 1 !important;
        }
        
        /* Processing page specific badges */
        body.bg-dark .workflow-stage .badge {
            background-color: #1e3a5f !important;
            color: #ffffff !important;
        }
        
        body.bg-dark .workflow-stage.pending .badge {
            background-color: #5a5a5a !important;  /* Gray for pending */
            color: #ffffff !important;
        }
        
        body.bg-dark .workflow-stage.running .badge {
            background-color: #1e3a5f !important;  /* Blue for running */
            color: #ffffff !important;
        }
        
        body.bg-dark .workflow-stage.completed .badge {
            background-color: #2d5a2d !important;  /* Green for completed */
            color: #ffffff !important;
        }
        
        /* Additional dark mode fixes for all pages */
        body.bg-dark .card {
            background-color: #2d2d2d !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
        }
        
        body.bg-dark .card-header {
            background-color: #1f1f1f !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #ffffff !important;
        }
        
        body.bg-dark .card-body {
            color: #e0e0e0 !important;
        }
        
        body.bg-dark .btn-outline-primary {
            color: #4a9eff !important;
            border-color: #4a9eff !important;
        }
        
        body.bg-dark .btn-outline-primary:hover {
            background-color: #4a9eff !important;
            color: #000000 !important;
        }
        
        body.bg-dark .btn-outline-secondary {
            color: #b0b0b0 !important;
            border-color: #6c757d !important;
        }
        
        body.bg-dark .btn-outline-secondary:hover {
            background-color: #6c757d !important;
            color: #ffffff !important;
        }
        
        body.bg-dark .btn-warning {
            background-color: #ffc107 !important;
            border-color: #ffc107 !important;
            color: #000000 !important;
        }
        
        body.bg-dark .btn-success {
            background-color: #28a745 !important;
            border-color: #28a745 !important;
            color: #ffffff !important;
        }
        
        /* Fix for chapter table in process_adaptation page */
        body.bg-dark .table-responsive {
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        body.bg-dark .table {
            color: #e0e0e0;
        }
        
        body.bg-dark .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(255, 255, 255, 0.03);
        }
        
        body.bg-dark .table td,
        body.bg-dark .table th {
            border-color: rgba(255, 255, 255, 0.1);
            vertical-align: middle;
        }
        
        /* Fix chapter badges visibility */
        body.bg-dark .badge.bg-primary {
            background-color: #0d6efd !important;
            color: #ffffff !important;
            border: none !important;
            padding: 0.35em 0.65em;
            font-size: 0.875em;
        }
        
        /* Fix chapter preview text overflow */
        body.bg-dark .table td small {
            color: #d0d0d0 !important;
            display: block;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            line-height: 1.4;
        }
        
        /* Improve table header visibility */
        body.bg-dark .table thead th {
            color: #b0b0b0 !important;
            font-weight: 600;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Fix alert styling in chapters table */
        body.bg-dark #chapters_table .alert-success {
            background-color: rgba(40, 167, 69, 0.2) !important;
            border-color: rgba(40, 167, 69, 0.3) !important;
            color: #90ee90 !important;
        }
        
        body.bg-dark #chapters_table .alert-light {
            background-color: rgba(255, 255, 255, 0.05) !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
            color: #c0c0c0 !important;
        }
        
        /* Fix chapter number badges to ensure proper sizing */
        #chapters_table .badge {
            min-width: 2.5em;
            display: inline-block;
            text-align: center;
        }
        
        /* Ensure proper column widths in chapter table */
        #chapters_table table {
            table-layout: fixed;
        }
        
        #chapters_table td:first-child {
            width: 70px;
        }
        
        #chapters_table td:last-child {
            width: 120px;
        }
        
        /* Fix text-muted colors in dark mode tables */
        body.bg-dark .table .text-muted {
            color: #9ca3af !important;
        }
        
        /* Fix ALL placeholders and empty states in dark mode */
        body.bg-dark .bg-light {
            background-color: #1e3a5f !important;
            border-color: #4a9eff !important;
        }
        
        body.bg-dark .bg-light .text-muted,
        body.bg-dark .bg-light i {
            color: #ffffff !important;
        }
        
        /* Fix all toast notifications for guaranteed visibility */
        body.bg-dark .toast,
        body.bg-dark .toast-body {
            background-color: #007bff !important;
            color: #ffffff !important;
            border: 2px solid #0056b3 !important;
        }
        
        /* Ensure all alerts in dark mode are visible */
        body.bg-dark .alert {
            font-weight: 500;
        }
        
        body.bg-dark .alert-success {
            background-color: #28a745 !important;
            color: #ffffff !important;
            border-color: #1e7e34 !important;
        }
        
        body.bg-dark .alert-danger {
            background-color: #dc3545 !important;
            color: #ffffff !important;
            border-color: #bd2130 !important;
        }
        
        body.bg-dark .alert-warning {
            background-color: #ffc107 !important;
            color: #000000 !important;
            border-color: #e0a800 !important;
        }
        
        body.bg-dark .alert-info {
            background-color: #17a2b8 !important;
            color: #ffffff !important;
            border-color: #117a8b !important;
        }
        
        /* Fix spinner colors in dark mode */
        body.bg-dark .spinner-border {
            color: #4a9eff !important;
        }
        
        body.bg-dark .spinner-border.text-primary {
            color: #4a9eff !important;
        }
        
        /* Service status indicators - ensure visibility */
        .bi-circle-fill {
            font-size: 0.75rem;
        }
        
        /* Progress bar enhancements */
        .progress {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        body.bg-dark .progress {
            background-color: rgba(0, 0, 0, 0.3);
        }
        
        /* Fix input and textarea contrast in dark mode */
        body.bg-dark input[type="text"],
        body.bg-dark input[type="email"],
        body.bg-dark input[type="password"],
        body.bg-dark input[type="number"],
        body.bg-dark input[type="search"],
        body.bg-dark input[type="url"],
        body.bg-dark textarea,
        body.bg-dark .form-control,
        body.bg-dark .form-select {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }
        
        body.bg-dark input[type="text"]:focus,
        body.bg-dark input[type="email"]:focus,
        body.bg-dark input[type="password"]:focus,
        body.bg-dark input[type="number"]:focus,
        body.bg-dark input[type="search"]:focus,
        body.bg-dark input[type="url"]:focus,
        body.bg-dark textarea:focus,
        body.bg-dark .form-control:focus,
        body.bg-dark .form-select:focus {
            background-color: #0d0d0d !important;
            color: #ffffff !important;
            border-color: #0d6efd !important;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
        }
        
        /* Fix placeholder text visibility */
        body.bg-dark input::placeholder,
        body.bg-dark textarea::placeholder {
            color: #6c757d !important;
            opacity: 0.8 !important;
        }
        
        /* Fix disabled inputs */
        body.bg-dark input:disabled,
        body.bg-dark textarea:disabled,
        body.bg-dark .form-control:disabled,
        body.bg-dark .form-select:disabled {
            background-color: #2a2a2a !important;
            color: #808080 !important;
            opacity: 0.6 !important;
        }
        
        /* Fix readonly inputs */
        body.bg-dark input[readonly],
        body.bg-dark textarea[readonly],
        body.bg-dark .form-control[readonly] {
            background-color: #1f1f1f !important;
            color: #b0b0b0 !important;
        }
        
        /* Specific fix for chapter processing textareas */
        body.bg-dark #chapters_table textarea,
        body.bg-dark .card-body textarea {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
        }
        
        /* Fix form labels in dark mode */
        body.bg-dark label,
        body.bg-dark .form-label {
            color: #c0c0c0 !important;
        }
        
        /* Fix form text helpers */
        body.bg-dark .form-text {
            color: #909090 !important;
        }
        
        /* COMPREHENSIVE CONTRAST FIXES - White on Blue Approach */
        
        /* Fix ALL text-muted elements for better visibility */
        body.bg-dark .text-muted,
        .theme-dark .text-muted,
        .theme-charcoal .text-muted {
            color: #c8d6e5 !important;  /* Light blue-gray for better contrast */
        }
        
        /* Fix ALL badge visibility issues */
        body.bg-dark .badge {
            font-weight: 600 !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        body.bg-dark .badge.bg-secondary,
        body.bg-dark .badge.bg-dark {
            background-color: #1e3a5f !important;  /* Blue background */
            color: #ffffff !important;
            border: 1px solid #4a9eff !important;
        }
        
        /* Fix ALL placeholder elements */
        body.bg-dark .placeholder-glow .placeholder,
        body.bg-dark .border.rounded {
            background-color: #1e3a5f !important;
            border-color: #4a9eff !important;
        }
        
        /* Fix image placeholders specifically */
        body.bg-dark .text-center.p-4.border.rounded {
            background-color: #1e3a5f !important;
            border: 2px solid #4a9eff !important;
        }
        
        body.bg-dark .text-center.p-4.border.rounded i {
            color: #4a9eff !important;
        }
        
        body.bg-dark .text-center.p-4.border.rounded p {
            color: #ffffff !important;
        }
        
        /* Fix ALL toast notifications */
        body.bg-dark .toast-container .toast {
            background-color: #1e3a5f !important;
            color: #ffffff !important;
            border: 2px solid #4a9eff !important;
        }
        
        body.bg-dark .toast-container .toast.bg-success {
            background-color: #1e5f3a !important;
            border-color: #28a745 !important;
        }
        
        body.bg-dark .toast-container .toast.bg-danger {
            background-color: #5f1e2b !important;
            border-color: #dc3545 !important;
        }
        
        body.bg-dark .toast-container .toast.bg-warning {
            background-color: #5f4a1e !important;
            border-color: #ffc107 !important;
        }
        
        /* Fix modal overlays and loading screens */
        body.bg-dark .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.8) !important;
        }
        
        body.bg-dark .loading-overlay {
            background-color: rgba(30, 58, 95, 0.95) !important;
            color: #ffffff !important;
        }
        
        body.bg-dark .spinner-border {
            color: #4a9eff !important;
        }
        
        /* Fix dropdown menus in dark mode */
        body.bg-dark .dropdown-menu {
            background-color: #1e3a5f !important;
            border: 1px solid #4a9eff !important;
        }
        
        body.bg-dark .dropdown-item {
            color: #ffffff !important;
        }
        
        body.bg-dark .dropdown-item:hover {
            background-color: #2b5278 !important;
        }
        
        /* Fix all small text elements */
        body.bg-dark small,
        body.bg-dark .small {
            color: #c8d6e5 !important;
        }
        
        /* Ensure all date/time metadata is visible */
        body.bg-dark .bi-calendar + span,
        body.bg-dark .bi-clock + span,
        body.bg-dark .bi-file-text + span {
            color: #ffffff !important;
        }
        /* Ensure Bootstrap modals are always above the high-z-index navbar */
        .modal { z-index: 12050 !important; }
        .modal-backdrop { z-index: 12040 !important; }
        /* Ensure PhotoSwipe overlay sits above navbar & modals */
        .pswp { z-index: 13050 !important; }
    </style>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- Alpine.js for reactive components -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    {% block extra_css %}{% endblock %}
</head>
<body class="bg-dark text-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark shadow-sm" style="z-index: 10001 !important; position: relative !important;">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <img src="/static/images/digital-gods-logo.png" alt="Digital Gods" class="digital-gods-logo me-2" style="width: 32px; height: 32px;">
                <div>
                    <span class="fw-bold">KidsKlassiks</span>
                    <small class="d-block text-warning" style="font-size: 0.7rem; line-height: 1;">by Digital Gods</small>
                </div>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link {% if request.url.path == '/' %}active{% endif %}" href="/">
                            <i class="bi bi-house"></i> Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.url.path == '/dashboard' %}active{% endif %}" href="/dashboard">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if 'books' in request.url.path %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-book"></i> Books
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/books/import">
                                <i class="bi bi-upload"></i> Import New Book
                            </a></li>
                            <li><a class="dropdown-item" href="/books/library">
                                <i class="bi bi-collection"></i> Browse Library
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/books/gutenberg">
                                <i class="bi bi-globe"></i> Project Gutenberg
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if 'adaptations' in request.url.path %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-layers"></i> Adaptations
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/adaptations/create">
                                <i class="bi bi-plus-circle"></i> New Adaptation
                            </a></li>
                            <li><a class="dropdown-item" href="/adaptations">
                                <i class="bi bi-list"></i> View All
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/adaptations/in-progress">
                                <i class="bi bi-hourglass-split"></i> In Progress
                            </a></li>
                            <li><a class="dropdown-item" href="/adaptations/completed">
                                <i class="bi bi-check-circle"></i> Completed
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.url.path == '/publish' %}active{% endif %}" href="/publish">
                            <i class="bi bi-file-earmark-pdf"></i> Publish
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <!-- Notifications -->
                    <li class="nav-item dropdown me-3">
                        <a class="nav-link position-relative" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-bell"></i>
                            {% if notifications_count > 0 %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                {{ notifications_count }}
                            </span>
                            {% endif %}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><h6 class="dropdown-header">Notifications</h6></li>
                            {% if notifications %}
                                {% for notification in notifications %}
                                <li>
                                    <a class="dropdown-item" href="{{ notification.link }}">
                                        <small class="text-muted">{{ notification.time }}</small><br>
                                        {{ notification.message }}
                                    </a>
                                </li>
                                {% endfor %}
                            {% else %}
                                <li><span class="dropdown-item-text text-muted">No new notifications</span></li>
                            {% endif %}
                        </ul>
                    </li>
                    
                    <!-- Help -->
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#helpModal">
                            <i class="bi bi-question-circle"></i> Help
                        </a>
                    </li>
                    
                    <!-- Theme Switcher -->
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="themeToggle" title="Change theme">
                            <i class="bi bi-moon-stars-fill" id="themeIcon"></i>
                        </a>
                    </li>
                    
                    <!-- Settings -->
                    <li class="nav-item">
                        <a class="nav-link {% if request.url.path == '/settings' %}active{% endif %}" href="/settings">
                            <i class="bi bi-gear"></i> Settings
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb (optional) -->
    {% block breadcrumb %}{% endblock %}

    <!-- Main Content -->
    <main class="{% block main_class %}{% endblock %}">
        <!-- Toast Container for notifications -->
        <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;">
            <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <i class="bi bi-info-circle-fill text-primary me-2"></i>
                    <strong class="me-auto">Notification</strong>
                    <small>just now</small>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>

        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="digital-gods-footer mt-5 py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5 class="mb-3 text-white">KidsKlassiks</h5>
                    <p class="text-white-50 small">
                        Transform classic literature into magical children's stories with AI.
                    </p>
                </div>
                <div class="col-md-4">
                    <h6 class="mb-3 text-white">Quick Links</h6>
                    <ul class="list-unstyled">
                        <li><a href="/books/import" class="text-white-50 text-decoration-none">Import Book</a></li>
                        <li><a href="/adaptations/create" class="text-white-50 text-decoration-none">New Adaptation</a></li>
                        <li><a href="/settings" class="text-white-50 text-decoration-none">Settings</a></li>
                        <li><a href="/help" class="text-white-50 text-decoration-none">Help</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6 class="mb-3 text-white">AI Services Status</h6>
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-circle-fill me-2 small" style="color: {{ '#28a745' if openai_status else '#dc3545' }} !important;"></i>
                        <span class="small" style="color: {{ '#28a745' if openai_status else '#dc3545' }} !important; font-weight: 500;">
                            OpenAI API {{ '✓' if openai_status else '✗' }}
                        </span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-circle-fill me-2 small" style="color: {{ '#28a745' if vertex_status else '#dc3545' }} !important;"></i>
                        <span class="small" style="color: {{ '#28a745' if vertex_status else '#dc3545' }} !important; font-weight: 500;">
                            Google Vertex AI {{ '✓' if vertex_status else '✗' }}
                        </span>
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-circle-fill me-2 small" style="color: #28a745 !important;"></i>
                        <span class="small" style="color: #28a745 !important; font-weight: 500;">
                            Database Connected ✓
                        </span>
                    </div>
                </div>
            </div>
            <hr>
            <div class="text-center small">
                <div class="mb-2 text-white-50">
                    © <span id="copyright-year"></span> <a href="https://digitalgods.ai" target="_blank" class="text-decoration-none text-primary fw-semibold">DigitalGods.ai</a>. All Rights Reserved.
                </div>
                <div>
                    <a href="#" class="text-primary text-decoration-none me-3 fw-semibold" data-bs-toggle="modal" data-bs-target="#termsModal">
                        <i class="bi bi-file-text"></i> Terms of Service
                    </a>
                    <a href="#" class="text-primary text-decoration-none me-3 fw-semibold" data-bs-toggle="modal" data-bs-target="#privacyModal">
                        <i class="bi bi-shield-check"></i> Privacy Policy
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Terms of Service Modal -->
    <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="termsModalLabel">
                        <i class="bi bi-file-text"></i> Terms of Service
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="p-3">
                        <h6 class="fw-bold mb-3">KidsKlassiks Terms of Service</h6>
                        <p class="text-muted small">Last Updated: <span id="terms-date"></span></p>
                        
                        <h6 class="mt-4 mb-2">1. Acceptance of Terms</h6>
                        <p>By accessing and using KidsKlassiks (the "Service"), you accept and agree to be bound by the terms and conditions of this agreement. The Service is owned and operated by DigitalGods.ai ("we", "us", or "our"). If you do not agree to these terms, please do not use the Service.</p>
                        
                        <h6 class="mt-4 mb-2">2. Description of Service</h6>
                        <p>KidsKlassiks is an AI-powered platform that transforms classic literature into age-appropriate children's stories. The Service uses artificial intelligence to adapt public domain books and generate illustrations.</p>
                        
                        <h6 class="mt-4 mb-2">3. User Obligations and Lawful Use</h6>
                        <p>You agree to use the Service only for lawful purposes and in compliance with all applicable laws and regulations. You specifically agree to:</p>
                        <ul>
                            <li>Not use the Service to create, distribute, or publish content that infringes upon intellectual property rights, including copyrights, trademarks, or patents</li>
                            <li>Only adapt and transform works that are in the public domain or for which you have explicit permission</li>
                            <li>Comply with all copyright laws, including proper attribution and fair use principles</li>
                            <li>Not use the Service to create content that is defamatory, obscene, threatening, harassing, or otherwise illegal</li>
                            <li>Not attempt to circumvent, disable, or interfere with security features of the Service</li>
                            <li>Not use automated systems to access the Service without express written permission</li>
                        </ul>
                        
                        <h6 class="mt-4 mb-2">4. Copyright and Intellectual Property</h6>
                        <p>You acknowledge and agree that:</p>
                        <ul>
                            <li>You are solely responsible for ensuring that any source material you upload to the Service is either in the public domain or properly licensed</li>
                            <li>You are solely responsible for any copyright infringement that may result from your use of the Service</li>
                            <li>DigitalGods.ai makes no representations or warranties regarding the copyright status of any materials</li>
                            <li>Content generated by the Service, including AI-generated text and images, may have complex ownership rights, and you are responsible for understanding and complying with applicable AI-generated content laws</li>
                        </ul>
                        
                        <h6 class="mt-4 mb-2">5. Disclaimer of Warranties</h6>
                        <p class="fw-bold">THE SERVICE IS PROVIDED "AS IS" AND "AS AVAILABLE" WITHOUT WARRANTIES OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO:</p>
                        <ul>
                            <li>Warranties of merchantability, fitness for a particular purpose, or non-infringement</li>
                            <li>Any warranty that the Service will be uninterrupted, timely, secure, or error-free</li>
                            <li>Any warranty regarding the accuracy, reliability, or quality of content generated by the Service</li>
                            <li>Any warranty that defects will be corrected or that the Service is free from viruses or harmful components</li>
                        </ul>
                        
                        <h6 class="mt-4 mb-2">6. Limitation of Liability</h6>
                        <p class="fw-bold">TO THE MAXIMUM EXTENT PERMITTED BY LAW, DIGITALGODS.AI AND ITS OFFICERS, DIRECTORS, EMPLOYEES, AND AGENTS SHALL NOT BE LIABLE FOR:</p>
                        <ul>
                            <li>Any indirect, incidental, special, consequential, or punitive damages</li>
                            <li>Any loss of profits, revenue, data, or use</li>
                            <li>Any damages arising from your use of or inability to use the Service</li>
                            <li>Any damages arising from copyright infringement claims by third parties</li>
                            <li>Any damages arising from content generated, adapted, or published using the Service</li>
                            <li>Any damages arising from unauthorized access to or alteration of your data</li>
                        </ul>
                        <p>IN NO EVENT SHALL DIGITALGODS.AI'S TOTAL LIABILITY TO YOU FOR ALL DAMAGES EXCEED THE AMOUNT PAID BY YOU, IF ANY, FOR ACCESSING THE SERVICE IN THE TWELVE (12) MONTHS PRECEDING THE CLAIM.</p>
                        
                        <h6 class="mt-4 mb-2">7. Indemnification</h6>
                        <p>You agree to indemnify, defend, and hold harmless DigitalGods.ai, its officers, directors, employees, agents, licensors, and suppliers from and against all losses, expenses, damages, costs, claims, and demands, including reasonable attorneys' fees, resulting from:</p>
                        <ul>
                            <li>Your violation of these Terms of Service</li>
                            <li>Your violation of any law or the rights of a third party</li>
                            <li>Your use of the Service, including any content you create, adapt, or publish</li>
                            <li>Any copyright or intellectual property infringement arising from your use of the Service</li>
                        </ul>
                        
                        <h6 class="mt-4 mb-2">8. AI-Generated Content Notice</h6>
                        <p>You acknowledge that content generated by this Service is created using artificial intelligence and may contain errors, inaccuracies, or inappropriate content. You are solely responsible for reviewing, editing, and validating all AI-generated content before publication or distribution.</p>
                        
                        <h6 class="mt-4 mb-2">9. Termination</h6>
                        <p>We reserve the right to terminate or suspend your access to the Service immediately, without prior notice or liability, for any reason, including but not limited to breach of these Terms.</p>
                        
                        <h6 class="mt-4 mb-2">10. Governing Law</h6>
                        <p>These Terms shall be governed by and construed in accordance with the laws of the jurisdiction in which DigitalGods.ai operates, without regard to its conflict of law provisions.</p>
                        
                        <h6 class="mt-4 mb-2">11. Changes to Terms</h6>
                        <p>We reserve the right to modify these Terms at any time. Continued use of the Service after changes constitutes acceptance of the modified Terms.</p>
                        
                        <h6 class="mt-4 mb-2">12. Contact Information</h6>
                        <p>For questions about these Terms, please contact DigitalGods.ai through our official website.</p>
                        
                        <div class="alert alert-warning mt-4">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Important:</strong> By using this Service, you acknowledge that you have read, understood, and agree to be bound by these Terms of Service.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="privacyModalLabel">
                        <i class="bi bi-shield-check"></i> Privacy Policy
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="p-3">
                        <h6 class="fw-bold mb-3">KidsKlassiks Privacy Policy</h6>
                        <p class="text-muted small">Last Updated: <span id="privacy-date"></span></p>
                        
                        <h6 class="mt-4 mb-2">1. Information We Collect</h6>
                        <p>KidsKlassiks collects the following information:</p>
                        <ul>
                            <li>Books and text content you upload for adaptation</li>
                            <li>Adaptations, chapters, and generated content you create</li>
                            <li>Usage data and technical information about how you use the Service</li>
                        </ul>
                        
                        <h6 class="mt-4 mb-2">2. How We Use Your Information</h6>
                        <p>We use your information to:</p>
                        <ul>
                            <li>Provide and improve the Service</li>
                            <li>Generate AI-powered adaptations and illustrations</li>
                            <li>Maintain and troubleshoot the Service</li>
                        </ul>
                        
                        <h6 class="mt-4 mb-2">3. Third-Party Services</h6>
                        <p>We use third-party AI services (OpenAI, Google Vertex AI) to generate content. Your data may be processed by these services in accordance with their privacy policies.</p>
                        
                        <h6 class="mt-4 mb-2">4. Data Security</h6>
                        <p>We implement reasonable security measures to protect your data, but cannot guarantee absolute security.</p>
                        
                        <h6 class="mt-4 mb-2">5. Your Rights</h6>
                        <p>You have the right to access, modify, or delete your data at any time through the Service.</p>
                        
                        <h6 class="mt-4 mb-2">6. Contact Us</h6>
                        <p>For privacy concerns, please contact DigitalGods.ai through our official website.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="helpModalLabel">
                        <i class="bi bi-question-circle"></i> KidsKlassiks User Guide
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="p-3">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Welcome to KidsKlassiks!</strong> This comprehensive guide will help you transform classic literature into engaging children's stories using AI.
                        </div>

                        <nav class="nav nav-pills flex-column flex-sm-row mb-4">
                            <a class="flex-sm-fill text-sm-center nav-link active" data-bs-toggle="tab" href="#help-overview">Overview</a>
                            <a class="flex-sm-fill text-sm-center nav-link" data-bs-toggle="tab" href="#help-books">Books</a>
                            <a class="flex-sm-fill text-sm-center nav-link" data-bs-toggle="tab" href="#help-adaptations">Adaptations</a>
                            <a class="flex-sm-fill text-sm-center nav-link" data-bs-toggle="tab" href="#help-transform">Transform <span class="badge bg-success ms-1">NEW</span></a>
                            <a class="flex-sm-fill text-sm-center nav-link" data-bs-toggle="tab" href="#help-images">Images</a>
                            <a class="flex-sm-fill text-sm-center nav-link" data-bs-toggle="tab" href="#help-publish">Publishing</a>
                            <a class="flex-sm-fill text-sm-center nav-link" data-bs-toggle="tab" href="#help-tips">Tips & FAQ</a>
                        </nav>

                        <div class="tab-content">
                            <!-- Overview Tab -->
                            <div class="tab-pane fade show active" id="help-overview">
                                <h5 class="mb-3"><i class="bi bi-book"></i> What is KidsKlassiks?</h5>
                                <p>KidsKlassiks is an AI-powered platform that transforms classic literature into age-appropriate children's stories. Using advanced artificial intelligence (GPT-4o-mini), you can:</p>
                                <ul>
                                    <li><strong>Import classic books</strong> from Project Gutenberg with automatic text cleaning</li>
                                    <li><strong>Automatically transform text</strong> - Victorian English becomes child-friendly language</li>
                                    <li><strong>Age-appropriate adaptation</strong> for 3-5, 6-8, or 9-12 years old</li>
                                    <li><strong>Character consistency</strong> - Same characters across all illustrations</li>
                                    <li><strong>Generate AI illustrations</strong> for chapters and covers (DALL-E 3)</li>
                                    <li><strong>Direct PDF download</strong> - Print-ready books instantly</li>
                                </ul>

                                <div class="alert alert-info mb-3">
                                    <i class="bi bi-stars"></i>
                                    <strong>What's New in v3.0:</strong> AI text transformation automatically simplifies complex Victorian prose into age-appropriate language while preserving the story!
                                </div>

                                <h6 class="mt-4 mb-2">Quick Start Workflow</h6>
                                <ol class="mb-3">
                                    <li><strong>Import a Book</strong> - Use Project Gutenberg (auto-cleaned) or upload your own</li>
                                    <li><strong>Create Adaptation</strong> - Choose age group (determines text complexity)</li>
                                    <li><strong>Transform Text</strong> - Click "Transform All Chapters" for AI simplification (NEW!)</li>
                                    <li><strong>Generate Images</strong> - Create cover and chapter illustrations with character consistency</li>
                                    <li><strong>Export PDF</strong> - Direct download, print-ready format (NEW!)</li>
                                </ol>

                                <div class="alert alert-success">
                                    <i class="bi bi-lightbulb"></i>
                                    <strong>Pro Tip:</strong> Try "A Christmas Carol" - it's auto-detected with proper Stave chapter structure and transforms beautifully for ages 6-8!
                                </div>
                            </div>

                            <!-- Books Tab -->
                            <div class="tab-pane fade" id="help-books">
                                <h5 class="mb-3"><i class="bi bi-collection"></i> Managing Books</h5>
                                
                                <h6 class="mt-3 mb-2">Importing from Project Gutenberg <span class="badge bg-success">ENHANCED</span></h6>
                                <ol>
                                    <li>Go to <strong>Books > Project Gutenberg</strong></li>
                                    <li>Search for a classic book by title or author</li>
                                    <li>Click <strong>"Import"</strong> on your chosen book</li>
                                    <li>System downloads and <strong>automatically cleans</strong> the text (NEW!)</li>
                                </ol>
                                <div class="alert alert-info">
                                    <i class="bi bi-magic"></i>
                                    <strong>Automatic Text Cleaning:</strong> Project Gutenberg legal boilerplate, START/END markers, and metadata are automatically removed - only the story remains!
                                </div>
                                <p class="text-muted small"><i class="bi bi-info-circle"></i> Project Gutenberg offers over 70,000 free public domain books.</p>

                                <h6 class="mt-4 mb-2">Uploading Your Own Books</h6>
                                <ol>
                                    <li>Go to <strong>Books > Import New Book</strong></li>
                                    <li>Enter book title and author</li>
                                    <li>Upload a text file (.txt) or paste content directly</li>
                                    <li>Click <strong>"Import Book"</strong> to add to your library</li>
                                </ol>
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <strong>Copyright Notice:</strong> Only upload books that are in the public domain or for which you have permission. You are responsible for copyright compliance.
                                </div>

                                <h6 class="mt-4 mb-2">Browsing Your Library</h6>
                                <p>Access <strong>Books > Browse Library</strong> to:</p>
                                <ul>
                                    <li>View all imported books</li>
                                    <li>See book details (title, author, word count, chapter count)</li>
                                    <li>Create new adaptations from existing books</li>
                                    <li>Delete books you no longer need</li>
                                </ul>
                            </div>

                            <!-- Adaptations Tab -->
                            <div class="tab-pane fade" id="help-adaptations">
                                <h5 class="mb-3"><i class="bi bi-layers"></i> Creating Adaptations</h5>
                                
                                <h6 class="mt-3 mb-2">Step 1: Start New Adaptation</h6>
                                <ol>
                                    <li>Go to <strong>Adaptations > New Adaptation</strong></li>
                                    <li>Select a book from your library</li>
                                    <li>Configure adaptation settings</li>
                                </ol>

                                <h6 class="mt-4 mb-2">Configuration Options</h6>
                                <ul>
                                    <li><strong>Target Age Group:</strong>
                                        <ul>
                                            <li><em>3-5 years:</em> Very simple vocabulary, short sentences, repetitive patterns</li>
                                            <li><em>6-8 years:</em> Simple vocabulary, moderate sentence length, clear storylines</li>
                                            <li><em>9-12 years:</em> Advanced vocabulary, complex sentences, detailed narratives</li>
                                        </ul>
                                    </li>
                                    <li><strong>Transformation Style:</strong> Fairy Tale, Adventure, Educational, Whimsical, etc.</li>
                                    <li><strong>Theme/Tone:</strong> Happy, Adventurous, Magical, Exciting, etc.</li>
                                    <li><strong>Key Characters:</strong> Which characters to preserve from the original</li>
                                </ul>

                                <h6 class="mt-4 mb-2">Step 2: Process Chapters</h6>
                                <ol>
                                    <li>After configuration, click <strong>"Process Chapters"</strong></li>
                                    <li>AI analyzes the book and creates chapter breakdowns</li>
                                    <li>Text is transformed to match the target age group</li>
                                    <li>Wait for processing to complete (usually 1-5 minutes)</li>
                                </ol>

                                <h6 class="mt-4 mb-2">Step 3: Review & Edit</h6>
                                <p>Once processing completes:</p>
                                <ul>
                                    <li>View all adapted chapters</li>
                                    <li>Read through transformed text</li>
                                    <li>Edit any chapter text directly in the interface</li>
                                    <li>Proceed to image generation when satisfied</li>
                                </ul>

                                <div class="alert alert-info">
                                    <i class="bi bi-clock"></i>
                                    <strong>Processing Time:</strong> Chapter processing typically takes 1-5 minutes depending on book length and complexity.
                                </div>
                            </div>

                            <!-- Transform Tab (NEW!) -->
                            <div class="tab-pane fade" id="help-transform">
                                <h5 class="mb-3"><i class="bi bi-stars"></i> AI Text Transformation <span class="badge bg-success">NEW v3.0</span></h5>
                                
                                <div class="alert alert-primary">
                                    <i class="bi bi-robot"></i>
                                    <strong>Powered by GPT-4o-mini:</strong> Automatically transforms complex Victorian English into child-friendly language while preserving the story, characters, and plot!
                                </div>

                                <h6 class="mt-3 mb-2">What Gets Transformed?</h6>
                                <ul>
                                    <li><strong>Victorian English → Simple language</strong> appropriate for target age</li>
                                    <li><strong>Long, complex sentences → Short, clear sentences</strong></li>
                                    <li><strong>Archaic vocabulary → Modern, everyday words</strong></li>
                                    <li><strong>Dense paragraphs → Bite-sized chunks</strong></li>
                                    <li><strong>Preserves:</strong> Story events, character names, plot points</li>
                                </ul>

                                <h6 class="mt-4 mb-2">Age-Specific Transformation Rules</h6>
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Age Group</th>
                                            <th>Vocabulary</th>
                                            <th>Sentences</th>
                                            <th>Length</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>3-5 years</strong></td>
                                            <td>Very simple (1-2 syllables)</td>
                                            <td>Very short (3-5 words)</td>
                                            <td>30-40% of original</td>
                                        </tr>
                                        <tr>
                                            <td><strong>6-8 years</strong></td>
                                            <td>Simple, everyday words</td>
                                            <td>Short (5-10 words)</td>
                                            <td>50-60% of original</td>
                                        </tr>
                                        <tr>
                                            <td><strong>9-12 years</strong></td>
                                            <td>Age-appropriate with challenges</td>
                                            <td>Varied (10-15 words)</td>
                                            <td>70-80% of original</td>
                                        </tr>
                                    </tbody>
                                </table>

                                <h6 class="mt-4 mb-2">How to Transform Text</h6>
                                
                                <h6 class="mt-3"><strong>Option 1: Transform All Chapters (Recommended)</strong></h6>
                                <ol>
                                    <li>Open your adaptation</li>
                                    <li>Click the <strong>"Transform All Chapters"</strong> button</li>
                                    <li>AI processes each chapter sequentially</li>
                                    <li>Watch progress with real-time statistics</li>
                                    <li>Review results when complete</li>
                                </ol>

                                <h6 class="mt-3"><strong>Option 2: Transform Individual Chapters</strong></h6>
                                <ol>
                                    <li>Navigate to a specific chapter</li>
                                    <li>Click <strong>"Transform Chapter"</strong></li>
                                    <li>Review the transformed text</li>
                                    <li>Edit manually if needed</li>
                                </ol>

                                <h6 class="mt-4 mb-2">Example Transformation</h6>
                                <div class="card mb-3">
                                    <div class="card-header bg-secondary text-white">
                                        <strong>Original (Victorian English):</strong> A Christmas Carol by Charles Dickens
                                    </div>
                                    <div class="card-body">
                                        <p class="small mb-0">"Marley was dead: to begin with. There is no doubt whatever about that. The register of his burial was signed by the clergyman, the clerk, the undertaker, and the chief mourner. Scrooge signed it: and Scrooge's name was good upon 'Change, for anything he chose to put his hand to."</p>
                                    </div>
                                </div>

                                <div class="card mb-3">
                                    <div class="card-header bg-success text-white">
                                        <strong>Transformed (Ages 6-8):</strong> Child-Friendly Version
                                    </div>
                                    <div class="card-body">
                                        <p class="small mb-0">"Marley had been dead for seven years. Everyone knew it. Important people had signed the papers that proved he was gone. Scrooge signed them too. People trusted Scrooge's signature because he was a businessman."</p>
                                    </div>
                                </div>

                                <div class="row mt-3">
                                    <div class="col-6">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-muted mb-1">158,371</h3>
                                                <small>Original Characters</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="card text-center border-success">
                                            <div class="card-body">
                                                <h3 class="text-success mb-1">65,031</h3>
                                                <small>Transformed Characters</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-center text-muted small mt-2">58% reduction - Perfect for ages 6-8!</p>

                                <h6 class="mt-4 mb-2">Manual Editing</h6>
                                <p>All transformed text is editable:</p>
                                <ul>
                                    <li>Click any chapter text to edit</li>
                                    <li>Refine AI-generated content</li>
                                    <li>Changes save automatically</li>
                                    <li>Perfect for adding personal touches</li>
                                </ul>

                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle"></i>
                                    <strong>Real Example:</strong> A Christmas Carol was transformed from complex Victorian prose to simple language - all 17 chapters in about 15 minutes!
                                </div>

                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <strong>Note:</strong> Transformation requires OpenAI API key configured in Settings. Uses GPT-4o-mini for cost-effective, high-quality results.
                                </div>
                            </div>

                            <!-- Images Tab -->
                            <div class="tab-pane fade" id="help-images">
                                <h5 class="mb-3"><i class="bi bi-image"></i> Generating Illustrations</h5>
                                
                                <div class="alert alert-info">
                                    <i class="bi bi-palette"></i>
                                    <strong>Character Consistency:</strong> Our two-layer prompt system ensures characters look the same across all images - same face, hair, clothing, and style!
                                </div>

                                <h6 class="mt-3 mb-2">Cover Images</h6>
                                <ol>
                                    <li>Navigate to your adaptation's image page</li>
                                    <li>In the <strong>Cover Image</strong> section:</li>
                                    <li>Click <strong>"Generate Prompt"</strong> - AI creates a detailed image description</li>
                                    <li>Review and edit the prompt if desired</li>
                                    <li>Click <strong>"Save Prompt"</strong> to save without generating (optional)</li>
                                    <li>Click <strong>"Generate Image"</strong> to create the cover</li>
                                    <li>Wait 10-15 seconds for AI image generation</li>
                                </ol>

                                <h6 class="mt-4 mb-2">Chapter Images</h6>
                                <ol>
                                    <li>Scroll to the <strong>Chapter Images</strong> section</li>
                                    <li>For each chapter:
                                        <ul>
                                            <li>Click <strong>"Generate Prompt"</strong> to create image description</li>
                                            <li>Edit the prompt to match your vision</li>
                                            <li>Click <strong>"Generate Image"</strong> to create illustration</li>
                                        </ul>
                                    </li>
                                    <li>Images appear immediately after generation</li>
                                    <li>Regenerate any image if you're not satisfied</li>
                                </ol>

                                <h6 class="mt-4 mb-2">AI Backend Options</h6>
                                <p>Configure in <strong>Settings</strong>:</p>
                                <ul>
                                    <li><strong>DALL-E 3 (OpenAI):</strong> High quality, consistent style, good text rendering</li>
                                    <li><strong>Vertex AI Imagen 4 (Google):</strong> Exceptional quality, photorealistic, superior text rendering</li>
                                </ul>

                                <h6 class="mt-4 mb-2">Image Settings</h6>
                                <p>In <strong>Settings</strong>, configure:</p>
                                <ul>
                                    <li><strong>Default Backend:</strong> Choose your preferred AI service</li>
                                    <li><strong>Image Size:</strong> Select aspect ratio (1024x1024, 1792x1024, etc.)</li>
                                    <li><strong>API Keys:</strong> Configure your OpenAI or Google Cloud credentials</li>
                                </ul>

                                <div class="alert alert-success">
                                    <i class="bi bi-magic"></i>
                                    <strong>Best Practice:</strong> Generate the cover first, then chapter images. This ensures consistent style throughout your book.
                                </div>

                                <div class="alert alert-warning">
                                    <i class="bi bi-hourglass-split"></i>
                                    <strong>Generation Time:</strong> Each image takes 10-15 seconds. For a 25-chapter book, budget 5-10 minutes for all illustrations.
                                </div>
                            </div>

                            <!-- Publishing Tab -->
                            <div class="tab-pane fade" id="help-publish">
                                <h5 class="mb-3"><i class="bi bi-file-earmark-pdf"></i> Publishing Your Adaptation</h5>
                                
                                <div class="alert alert-success">
                                    <i class="bi bi-download"></i>
                                    <strong>Direct Download (NEW!):</strong> PDFs download immediately - no more "we'll notify you when ready"!
                                </div>

                                <h6 class="mt-3 mb-2">Publish Page Overview <span class="badge bg-primary">ENHANCED</span></h6>
                                <p>Go to <strong>Publish</strong> to see all your adaptations with beautiful new features:</p>
                                <ul>
                                    <li><strong>Gradient purple header</strong> - Modern, professional look (NEW!)</li>
                                    <li><strong>Green "Ready to Publish" indicators</strong> (NEW!)</li>
                                    <li><strong>Cover thumbnails</strong> displayed prominently</li>
                                    <li><strong>Progress statistics:</strong> Chapter count, image count with progress bars (NEW!)</li>
                                    <li><strong>Visual progress bars:</strong> See X/Y completion percentage (NEW!)</li>
                                    <li><strong>Status badges:</strong> Cover status, illustration percentage</li>
                                </ul>

                                <h6 class="mt-4 mb-2">Preview Your Book</h6>
                                <ol>
                                    <li>Click <strong>"Preview"</strong> on any adaptation</li>
                                    <li>View a beautiful book-style layout with:
                                        <ul>
                                            <li>Cover image and title page</li>
                                            <li>All chapters with transformed text (NEW!)</li>
                                            <li>Chapter illustrations</li>
                                            <li>Complete formatted content</li>
                                        </ul>
                                    </li>
                                    <li>Use <strong>"Print"</strong> button for browser print</li>
                                    <li>Scroll through to review entire book</li>
                                </ol>

                                <h6 class="mt-4 mb-2">Export as PDF <span class="badge bg-success">ENHANCED</span></h6>
                                <ol>
                                    <li>From the Publish page, click <strong>"Export PDF"</strong></li>
                                    <li>PDF generates instantly with all content and images</li>
                                    <li><strong>Downloads immediately</strong> - no waiting! (NEW!)</li>
                                    <li>Print-ready format with proper cover and chapter mapping</li>
                                    <li>Share your adapted book with children!</li>
                                </ol>

                                <div class="alert alert-info">
                                    <i class="bi bi-check2-all"></i>
                                    <strong>What's Included:</strong> PDFs contain cover image, all transformed text, chapter illustrations, proper formatting - everything you need for a professional children's book!
                                </div>

                                <h6 class="mt-4 mb-2">Publishing Checklist</h6>
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <p class="mb-2">Before publishing, ensure:</p>
                                        <ul class="mb-0">
                                            <li>✓ All chapters have been processed and reviewed</li>
                                            <li>✓ Cover image has been generated</li>
                                            <li>✓ Chapter images are complete (or as desired)</li>
                                            <li>✓ Text has been proofread and edited</li>
                                            <li>✓ Content is appropriate for target age group</li>
                                            <li>✓ Copyright compliance verified</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Tips & FAQ Tab -->
                            <div class="tab-pane fade" id="help-tips">
                                <h5 class="mb-3"><i class="bi bi-lightbulb"></i> Tips & Best Practices</h5>
                                
                                <h6 class="mt-3 mb-2">Optimization Tips</h6>
                                <ul>
                                    <li><strong>Transform First, Then Images:</strong> Transform all chapters before generating images (NEW!)</li>
                                    <li><strong>Use "Transform All":</strong> Batch transformation is faster than one-by-one (NEW!)</li>
                                    <li><strong>Choose the Right Age Group:</strong> This affects text transformation complexity (IMPORTANT!)</li>
                                    <li><strong>Review Transformed Text:</strong> AI is good but manual refinement makes it great</li>
                                    <li><strong>Character Consistency:</strong> Let the system maintain character descriptions automatically</li>
                                    <li><strong>Consistent Style:</strong> Generate all images with the same AI backend</li>
                                    <li><strong>Project Gutenberg:</strong> Use auto-cleaned books for best results</li>
                                    <li><strong>Save Prompts:</strong> Save good image prompts before generating</li>
                                </ul>

                                <h6 class="mt-4 mb-2">Common Issues & Solutions</h6>
                                <div class="accordion" id="faqAccordion">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                                                Images not showing after generation?
                                            </button>
                                        </h2>
                                        <div id="faq1" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                            <div class="accordion-body">
                                                <strong>Solution:</strong> Refresh the page to clear browser cache. Images are cached with timestamps but may need a manual refresh.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                                                Chapter processing taking too long?
                                            </button>
                                        </h2>
                                        <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                            <div class="accordion-body">
                                                <strong>Solution:</strong> Processing time depends on book length. Books with 20+ chapters may take 3-5 minutes. Be patient and don't refresh the page during processing.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                                                Want to change image backend?
                                            </button>
                                        </h2>
                                        <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                            <div class="accordion-body">
                                                <strong>Solution:</strong> Go to Settings and change the "Default Image Backend". Configure API keys if switching to a new service. Settings persist across sessions.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq4">
                                                How to ensure copyright compliance?
                                            </button>
                                        </h2>
                                        <div id="faq4" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                            <div class="accordion-body">
                                                <strong>Solution:</strong> Only use books that are:
                                                <ul>
                                                    <li>In the public domain (published before 1928 in most cases)</li>
                                                    <li>From Project Gutenberg (all public domain)</li>
                                                    <li>Licensed for adaptation (get written permission)</li>
                                                </ul>
                                                You are solely responsible for copyright compliance.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq5">
                                                Can I edit the adapted text?
                                            </button>
                                        </h2>
                                        <div id="faq5" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                            <div class="accordion-body">
                                                <strong>Yes!</strong> All chapter text is editable. Click on any chapter text field, make your changes, and they're automatically saved. This allows you to refine AI-generated content.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq6">
                                                How does AI text transformation work? (NEW!)
                                            </button>
                                        </h2>
                                        <div id="faq6" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                            <div class="accordion-body">
                                                <strong>GPT-4o-mini powered!</strong> Our AI analyzes the original text and transforms it based on your target age group:
                                                <ul class="mt-2">
                                                    <li><strong>Ages 3-5:</strong> Very simple words, 3-5 word sentences, 30-40% length</li>
                                                    <li><strong>Ages 6-8:</strong> Simple words, 5-10 word sentences, 50-60% length</li>
                                                    <li><strong>Ages 9-12:</strong> Age-appropriate words, 10-15 word sentences, 70-80% length</li>
                                                </ul>
                                                The AI preserves story events, character names, and plot while simplifying language. You can then edit the results manually.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq7">
                                                Do I need to transform text for every book? (NEW!)
                                            </button>
                                        </h2>
                                        <div id="faq7" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                            <div class="accordion-body">
                                                <strong>Highly recommended for classics!</strong> Books from Project Gutenberg (Victorian era) have complex language that children find difficult. Transformation makes them accessible. For already-simple books, you can skip transformation and use the original text.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq8">
                                                Why does PDF download immediately now? (NEW!)
                                            </button>
                                        </h2>
                                        <div id="faq8" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                            <div class="accordion-body">
                                                <strong>We upgraded!</strong> The old system used notifications and delayed downloads. v3.0 generates PDFs instantly and downloads directly to your browser - much faster and more convenient!
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq9">
                                                What is character consistency? (NEW!)
                                            </button>
                                        </h2>
                                        <div id="faq9" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                            <div class="accordion-body">
                                                <strong>Same characters, every image!</strong> Our two-layer prompt system ensures characters look identical across all illustrations:
                                                <ul class="mt-2">
                                                    <li><strong>Layer 1:</strong> Base character description (age, hair, clothing, features)</li>
                                                    <li><strong>Layer 2:</strong> Scene-specific actions and context</li>
                                                </ul>
                                                This means Scrooge looks like Scrooge in every chapter image - professional book quality!
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq10">
                                                How long does text transformation take? (NEW!)
                                            </button>
                                        </h2>
                                        <div id="faq10" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                            <div class="accordion-body">
                                                <strong>Pretty fast!</strong> Transformation time depends on chapter count and length:
                                                <ul class="mt-2">
                                                    <li><strong>Small book (5-10 chapters):</strong> 2-5 minutes</li>
                                                    <li><strong>Medium book (10-20 chapters):</strong> 5-15 minutes</li>
                                                    <li><strong>Large book (20+ chapters):</strong> 15-30 minutes</li>
                                                </ul>
                                                Example: A Christmas Carol (17 chapters) transforms in about 15 minutes.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <h6 class="mt-4 mb-2">Keyboard Shortcuts</h6>
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td><code>Ctrl/Cmd + S</code></td>
                                            <td>Save current changes (when editing)</td>
                                        </tr>
                                        <tr>
                                            <td><code>Esc</code></td>
                                            <td>Close modal windows</td>
                                        </tr>
                                        <tr>
                                            <td><code>Ctrl/Cmd + P</code></td>
                                            <td>Print preview page</td>
                                        </tr>
                                    </tbody>
                                </table>

                                <div class="alert alert-info mt-4">
                                    <i class="bi bi-envelope"></i>
                                    <strong>Need More Help?</strong> Contact support through <a href="https://digitalgods.ai" target="_blank">DigitalGods.ai</a> for technical assistance.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- PhotoSwipe JS (UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/photoswipe@5/dist/photoswipe.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/photoswipe@5/dist/photoswipe-lightbox.umd.min.js"></script>
    <script>
      // Initialize PhotoSwipe on any gallery container with class .pswp-gallery
      document.addEventListener('DOMContentLoaded', function() {
        const galleries = document.querySelectorAll('.pswp-gallery');
        const hasPhotoSwipe = !!(window.PhotoSwipeLightbox && window.PhotoSwipe);

        if (hasPhotoSwipe) {
          galleries.forEach(function(galleryEl) {
            const lightbox = new PhotoSwipeLightbox({
              gallery: galleryEl,
              children: 'a',
              pswpModule: PhotoSwipe,
              bgOpacity: 0.95,
              closeOnVerticalDrag: true,
              wheelToZoom: true
            });
            lightbox.init();
          });
          return;
        }

        // Fallback: if PhotoSwipe failed to load (CSP/CDN), use a Bootstrap modal overlay
        // Create reusable fallback modal once
        if (!document.getElementById('imageFallbackModal')) {
          const modalEl = document.createElement('div');
          modalEl.id = 'imageFallbackModal';
          modalEl.className = 'modal fade';
          modalEl.tabIndex = -1;
          modalEl.innerHTML = `
            <div class="modal-dialog modal-xl modal-dialog-centered">
              <div class="modal-content bg-transparent border-0">
                <div class="modal-body text-center p-0 position-relative">
                  <button type="button" class="btn-close btn-close-white position-absolute" data-bs-dismiss="modal" style="top: 16px; right: 16px; z-index: 2;"></button>
                  <img id="imageFallbackModalImg" src="" alt="Image" class="img-fluid rounded shadow-lg" style="max-height: 90vh;" />
                </div>
              </div>
            </div>`;
          document.body.appendChild(modalEl);

          // Cleanup on hide (belt-and-suspenders)
          modalEl.addEventListener('hidden.bs.modal', function () {
            document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
          });
        }

        // Intercept clicks on gallery links and open in fallback modal
        galleries.forEach(function(galleryEl) {
          galleryEl.addEventListener('click', function(e) {
            const a = e.target.closest('a');
            if (!a) return;
            e.preventDefault();
            const imgSrc = a.getAttribute('href');
            const modalRoot = document.getElementById('imageFallbackModal');
            if (modalRoot && modalRoot.parentNode !== document.body) {
              document.body.appendChild(modalRoot);
            }
            const imgEl = document.getElementById('imageFallbackModalImg');
            if (imgEl) imgEl.src = imgSrc;
            const modal = bootstrap.Modal.getOrCreateInstance(modalRoot, { backdrop: true, keyboard: true, focus: true });
            modal.show();
          });
        });
      });
    </script>
    
    <!-- Custom JS -->
    <script>
        // Set current year for copyright
        document.getElementById('copyright-year').textContent = new Date().getFullYear();
        
        // Set current date for terms and privacy
        const currentDate = new Date().toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        const termsDateEl = document.getElementById('terms-date');
        const privacyDateEl = document.getElementById('privacy-date');
        if (termsDateEl) termsDateEl.textContent = currentDate;
        if (privacyDateEl) privacyDateEl.textContent = currentDate;
        
        // HTMX event handlers
        document.body.addEventListener('htmx:afterRequest', function(event) {
            // Handle successful responses
            if (event.detail.successful) {
                // Check for success messages
                const response = event.detail.xhr.response;
                if (response.includes('success')) {
                    showToast('Success', 'Operation completed successfully', 'success');
                }
            }
        });

        // Toast notification function
        function showToast(title, message, type = 'info') {
            const toastEl = document.getElementById('liveToast');
            const toastHeader = toastEl.querySelector('.toast-header strong');
            const toastBody = toastEl.querySelector('.toast-body');
            const toastIcon = toastEl.querySelector('.toast-header i');
            
            // Update content
            toastHeader.textContent = title;
            toastBody.textContent = message;
            
            // Update icon based on type
            toastIcon.className = `bi me-2 ${
                type === 'success' ? 'bi-check-circle-fill text-success' :
                type === 'error' ? 'bi-x-circle-fill text-danger' :
                type === 'warning' ? 'bi-exclamation-triangle-fill text-warning' :
                'bi-info-circle-fill text-primary'
            }`;
            
            // Show toast
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        // Initialize tooltips
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

        // Theme System - 3 themes: system (default), dark, charcoal
        const themes = ['system', 'dark', 'charcoal'];
        const themeIcons = {
            'system': 'bi-circle-half',           // Half moon for system theme
            'dark': 'bi-moon-stars-fill',         // Full moon with stars for dark
            'charcoal': 'bi-moon-fill'            // Solid moon for charcoal
        };
        
        function getStoredTheme() {
            return localStorage.getItem('theme') || 'system';
        }
        
        function setStoredTheme(theme) {
            localStorage.setItem('theme', theme);
        }
        
        function getSystemTheme() {
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        
        function applyTheme(theme) {
            // Remove all theme classes
            document.documentElement.removeAttribute('data-bs-theme');
            document.body.classList.remove('theme-system', 'theme-dark', 'theme-charcoal');
            
            if (theme === 'system') {
                // Use system preference
                const systemTheme = getSystemTheme();
                document.documentElement.setAttribute('data-bs-theme', systemTheme);
                document.body.classList.add('theme-system');
            } else if (theme === 'dark') {
                // Pure dark theme (black background)
                document.documentElement.setAttribute('data-bs-theme', 'dark');
                document.body.classList.add('theme-dark');
            } else if (theme === 'charcoal') {
                // Charcoal theme (dark gray background)
                document.documentElement.setAttribute('data-bs-theme', 'dark');
                document.body.classList.add('theme-charcoal');
            }
            
            // Update icon
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) {
                // Remove all icon classes
                themeIcon.className = '';
                // Add new icon class
                themeIcon.classList.add('bi', themeIcons[theme]);
            }
        }
        
        function cycleTheme() {
            const currentTheme = getStoredTheme();
            const currentIndex = themes.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % themes.length;
            const nextTheme = themes[nextIndex];
            
            setStoredTheme(nextTheme);
            applyTheme(nextTheme);
            
            // Show toast notification
            showThemeToast(nextTheme);
        }
        
        function showThemeToast(theme) {
            const themeNames = {
                'system': 'System Theme',
                'dark': 'Dark Theme',
                'charcoal': 'Charcoal Theme'
            };
            
            const toast = document.getElementById('liveToast');
            if (toast) {
                const toastBody = toast.querySelector('.toast-body');
                if (toastBody) {
                    toastBody.textContent = `Switched to ${themeNames[theme]}`;
                }
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
            }
        }
        
        // Initialize theme on page load
        applyTheme(getStoredTheme());
        
        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            if (getStoredTheme() === 'system') {
                applyTheme('system');
            }
        });
        
        // Attach theme toggle to button
        document.getElementById('themeToggle')?.addEventListener('click', (e) => {
            e.preventDefault();
            cycleTheme();
        });

        // Fix dropdown positioning and z-index issues
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure dropdowns have proper positioning when shown
            document.querySelectorAll('.navbar .dropdown').forEach(function(dropdown) {
                dropdown.addEventListener('show.bs.dropdown', function() {
                    const menu = this.querySelector('.dropdown-menu');
                    if (menu) {
                        // Reset positioning to allow proper alignment
                        menu.style.zIndex = '10000';
                        menu.style.position = 'absolute';
                        menu.style.left = '0';
                        menu.style.top = '100%';
                        menu.style.transform = 'none';
                    }
                });
                
                dropdown.addEventListener('shown.bs.dropdown', function() {
                    const menu = this.querySelector('.dropdown-menu');
                    if (menu) {
                        // Ensure positioning stays correct after animation
                        menu.style.zIndex = '10000';
                        menu.style.position = 'absolute';
                        menu.style.left = '0';
                        menu.style.top = '100%';
                        menu.style.transform = 'none';
                    }
                });
            });
        });
    </script>
    
    <!-- Digital Gods Enhanced Animations -->
    <script src="/static/js/digital-gods-animations.js"></script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
