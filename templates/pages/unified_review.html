{% extends "layouts/base.html" %}

{% block title %}Review & Edit - {{ adaptation.title | default('Adaptation', true) }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-pencil-square text-primary"></i>
                        Review & Edit Adaptation
                    </h1>
                    <p class="text-muted mb-0 mt-2">
                        {{ book.title }} - {{ adaptation.target_age_group }}
                    </p>
                </div>
                <div>
                    <a href="/adaptations/{{ adaptation.adaptation_id }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Adaptation
                    </a>
                    <button id="save-all-btn" class="btn btn-success" onclick="saveAllChanges()">
                        <i class="bi bi-save"></i> Save All Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Overview -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h4 class="mb-1">{{ chapters | length }}</h4>
                            <p class="text-muted mb-0">Total Chapters</p>
                        </div>
                        <div class="col-md-3">
                            <h4 class="mb-1 text-success">{{ transformed_count }}</h4>
                            <p class="text-muted mb-0">Transformed</p>
                        </div>
                        <div class="col-md-3">
                            <h4 class="mb-1 text-info">{{ prompts_count }}</h4>
                            <p class="text-muted mb-0">Prompts Ready</p>
                        </div>
                        <div class="col-md-3">
                            <h4 class="mb-1 text-warning">{{ images_count }}</h4>
                            <p class="text-muted mb-0">Images Generated</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cover Page Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header" style="background: linear-gradient(135deg, rgba(138, 43, 226, 0.1), rgba(75, 0, 130, 0.05));">
                    <h5 class="mb-0">
                        <i class="bi bi-image-fill"></i> Cover Page
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3">Cover Image</h6>
                            {% if adaptation.cover_url %}
                                <div class="text-center mb-3">
                                    <img src="{{ adaptation.cover_url }}" alt="Cover Image" class="img-fluid rounded shadow-sm" style="max-height: 300px; cursor: pointer;" onclick="viewCoverImage()">
                                </div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary" onclick="regenerateCover()">
                                        <i class="bi bi-arrow-clockwise"></i> Regenerate Cover Image
                                    </button>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> No cover image generated yet.
                                </div>
                                <div class="d-grid">
                                    <button class="btn btn-primary" onclick="generateCover()">
                                        <i class="bi bi-magic"></i> Generate Cover Image
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">Cover Prompt</h6>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <p class="mb-0" id="coverPromptDisplay">
                                        {{ adaptation.cover_prompt or 'No cover prompt set yet.' }}
                                    </p>
                                </div>
                            </div>
                            <div class="mt-3 d-grid gap-2">
                                {% if adaptation.cover_prompt %}
                                <button class="btn btn-sm btn-outline-info" onclick="generateAICoverPrompt()" id="generatePromptBtn">
                                    <i class="bi bi-arrow-clockwise"></i> Regenerate AI Prompt
                                </button>
                                {% else %}
                                <button class="btn btn-sm btn-success" onclick="generateAICoverPrompt()" id="generatePromptBtn">
                                    <i class="bi bi-stars"></i> Generate AI Cover Prompt
                                </button>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-secondary" onclick="editCoverPrompt()">
                                    <i class="bi bi-pencil"></i> Edit Manually
                                </button>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-magic"></i> <strong>AI-Powered:</strong> Analyzes the entire book to extract themes, characters, setting, and emotional arc for the perfect cover.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chapters Grid -->
    <div class="row">
        {% for chapter in chapters %}
        <div class="col-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            Chapter {{ chapter.chapter_number }}: 
                            <span id="title-{{ chapter.chapter_id }}" contenteditable="true" class="editable-title">
                                {{ chapter.title | default('Untitled', true) }}
                            </span>
                        </h5>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="toggleChapter({{ chapter.chapter_id }})">
                                <i class="bi bi-chevron-down" id="toggle-icon-{{ chapter.chapter_id }}"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body" id="chapter-content-{{ chapter.chapter_id }}">
                    <div class="row">
                        <!-- Image Section (moved to left) -->
                        <div class="col-md-4">
                            <ul class="nav nav-tabs mb-3" role="tablist" style="background-color: rgba(255, 255, 255, 0.05);">
                                <li class="nav-item">
                                    <a class="nav-link active" data-bs-toggle="tab" 
                                       href="#transformed-{{ chapter.chapter_id }}"
                                       style="color: #ffffff; background-color: transparent; border-color: rgba(255, 255, 255, 0.2);">
                                        Transformed Text
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" 
                                       href="#original-{{ chapter.chapter_id }}"
                                       style="color: #ffffff; background-color: transparent; border-color: rgba(255, 255, 255, 0.2);">
                                        Original Text
                                    </a>
                                </li>
                            </ul>
                            
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="transformed-{{ chapter.chapter_id }}">
                                    <div class="mb-2">
                                        <span class="badge bg-info">
                                            {{ (chapter.transformed_text | default('', true) | length) }} chars
                                        </span>
                                        {% if not chapter.transformed_text %}
                                        <button class="btn btn-sm btn-warning ms-2" 
                                                onclick="transformChapter({{ chapter.chapter_id }})">
                                            <i class="bi bi-magic"></i> Transform Text
                                        </button>
                                        {% endif %}
                                    </div>
                                    <textarea class="form-control chapter-text" 
                                              id="transformed-text-{{ chapter.chapter_id }}"
                                              rows="10"
                                              placeholder="Transformed text will appear here..."
                                              onchange="markAsChanged({{ chapter.chapter_id }})">{{ chapter.transformed_text | default('', true) }}</textarea>
                                </div>
                                
                                <div class="tab-pane fade" id="original-{{ chapter.chapter_id }}">
                                    <div class="mb-2">
                                        <span class="badge bg-secondary">
                                            {{ (chapter.original_text_segment | default('', true) | length) }} chars
                                        </span>
                                    </div>
                                    <textarea class="form-control" rows="10" readonly>{{ chapter.original_text_segment | default('', true) }}</textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Text Section (moved to right) -->
                        <div class="col-md-8">
                            <div class="card" style="background-color: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);">
                                <div class="card-header">
                                    <h6 class="mb-0">Chapter Image</h6>
                                </div>
                                <div class="card-body">
                                    <!-- Image Display -->
                                    <div class="mb-3 text-center" id="image-container-{{ chapter.chapter_id }}">
                                        {% if chapter.image_url %}
                                        <img src="{{ chapter.image_url }}" 
                                             class="img-fluid rounded shadow-sm mb-2" 
                                             style="max-height: 200px;"
                                             alt="Chapter {{ chapter.chapter_number }}">
                                        <div>
                                            <button class="btn btn-sm btn-outline-danger" 
                                                    onclick="deleteImage({{ chapter.chapter_id }})">
                                                <i class="bi bi-trash"></i> Delete
                                            </button>
                                        </div>
                                        {% else %}
                                        <div class="text-muted py-4">
                                            <i class="bi bi-image" style="font-size: 3rem;"></i>
                                            <p>No image generated</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Image Prompt -->
                                    <div class="mb-3">
                                        <label class="form-label">Image Prompt</label>
                                        <textarea class="form-control" 
                                                  id="prompt-{{ chapter.chapter_id }}"
                                                  rows="4"
                                                  placeholder="Enter or edit image prompt..."
                                                  onchange="markAsChanged({{ chapter.chapter_id }})">{{ chapter.ai_prompt | default('', true) }}</textarea>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="d-grid gap-2">
                                        {% if not chapter.ai_prompt %}
                                        <button class="btn btn-info btn-sm" 
                                                onclick="generatePrompt({{ chapter.chapter_id }})">
                                            <i class="bi bi-lightbulb"></i> Generate Prompt
                                        </button>
                                        {% endif %}
                                        
                                        <button class="btn btn-primary btn-sm" 
                                                id="gen-img-btn-{{ chapter.chapter_id }}"
                                                onclick="generateImage({{ chapter.chapter_id }})"
                                                {% if not chapter.ai_prompt %}disabled{% endif %}>
                                            <i class="bi bi-image"></i> Generate Image
                                        </button>
                                    </div>
                                    
                                    <!-- Status -->
                                    <div class="mt-2" id="status-{{ chapter.chapter_id }}"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Publish Button -->
    <div class="row mt-4">
        <div class="col text-center">
            <a href="/publish/{{ adaptation.adaptation_id }}" 
               class="btn btn-lg btn-success">
                <i class="bi bi-book"></i> Proceed to Publishing
            </a>
        </div>
    </div>
</div>

<script>
// Track changed chapters
const changedChapters = new Set();

function markAsChanged(chapterId) {
    changedChapters.add(chapterId);
    document.getElementById('save-all-btn').classList.add('btn-warning');
}

function toggleChapter(chapterId) {
    const content = document.getElementById(`chapter-content-${chapterId}`);
    const icon = document.getElementById(`toggle-icon-${chapterId}`);
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.className = 'bi bi-chevron-up';
    } else {
        content.style.display = 'none';
        icon.className = 'bi bi-chevron-down';
    }
}

async function transformChapter(chapterId) {
    const statusEl = document.getElementById(`status-${chapterId}`);
    statusEl.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Transforming...';
    
    try {
        const response = await fetch(`/chapters/${chapterId}/transform`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const data = await response.json();
            document.getElementById(`transformed-text-${chapterId}`).value = data.transformed_text;
            statusEl.innerHTML = '<div class="alert alert-success">Transformation complete!</div>';
            setTimeout(() => statusEl.innerHTML = '', 3000);
        } else {
            statusEl.innerHTML = '<div class="alert alert-danger">Transformation failed</div>';
        }
    } catch (error) {
        statusEl.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
    }
}

async function generatePrompt(chapterId) {
    const statusEl = document.getElementById(`status-${chapterId}`);
    statusEl.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Generating prompt...';
    
    try {
        const response = await fetch(`/chapters/${chapterId}/generate-prompt`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const data = await response.json();
            document.getElementById(`prompt-${chapterId}`).value = data.prompt;
            statusEl.innerHTML = '<div class="alert alert-success">Prompt generated!</div>';
            setTimeout(() => statusEl.innerHTML = '', 3000);
        } else {
            statusEl.innerHTML = '<div class="alert alert-danger">Failed to generate prompt</div>';
        }
    } catch (error) {
        statusEl.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
    }
}

async function generateImage(chapterId) {
    const prompt = document.getElementById(`prompt-${chapterId}`).value;
    if (!prompt) {
        alert('Please enter or generate a prompt first');
        return;
    }
    
    const statusEl = document.getElementById(`status-${chapterId}`);
    const imageContainer = document.getElementById(`image-container-${chapterId}`);
    const genBtn = document.getElementById(`gen-img-btn-${chapterId}`);
    
    // Disable button and show progress
    if (genBtn) {
        genBtn.disabled = true;
        genBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Generating...';
    }
    
    statusEl.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split"></i> Generating image with GPT-Image-1...</div>';
    
    try {
        const response = await fetch(`/chapters/${chapterId}/generate-image`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ prompt: prompt })
        });
        
        if (response.ok) {
            const data = await response.json();
            imageContainer.innerHTML = `
                <img src="${data.image_url}" class="img-fluid rounded shadow-sm mb-2" style="max-height: 200px;">
                <div>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteImage(${chapterId})">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            `;
            statusEl.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> Image generated successfully!</div>';
            setTimeout(() => statusEl.innerHTML = '', 3000);
        } else {
            const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
            const errorMsg = errorData.error || errorData.message || 'Failed to generate image';
            statusEl.innerHTML = `<div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> <strong>Image Generation Failed:</strong><br>
                <small>${errorMsg}</small>
            </div>`;
            console.error('Image generation error:', errorData);
        }
    } catch (error) {
        statusEl.innerHTML = `<div class="alert alert-danger">
            <i class="bi bi-x-circle"></i> <strong>Error:</strong> ${error.message}
        </div>`;
    } finally {
        // Restore button state
        const genBtn = document.getElementById(`gen-img-btn-${chapterId}`);
        if (genBtn) {
            genBtn.disabled = false;
            genBtn.innerHTML = '<i class="bi bi-image"></i> Generate Image';
        }
    }
}

async function deleteImage(chapterId) {
    if (!confirm('Are you sure you want to delete this image?')) return;
    
    const statusEl = document.getElementById(`status-${chapterId}`);
    statusEl.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Deleting...';
    
    try {
        const response = await fetch(`/chapters/${chapterId}/image`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            document.getElementById(`image-container-${chapterId}`).innerHTML = `
                <div class="text-muted py-4">
                    <i class="bi bi-image" style="font-size: 3rem;"></i>
                    <p>No image generated</p>
                </div>
            `;
            statusEl.innerHTML = '<div class="alert alert-success">Image deleted</div>';
            setTimeout(() => statusEl.innerHTML = '', 3000);
        } else {
            statusEl.innerHTML = '<div class="alert alert-danger">Failed to delete image</div>';
        }
    } catch (error) {
        statusEl.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
    }
}

async function saveAllChanges() {
    const btn = document.getElementById('save-all-btn');
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
    btn.disabled = true;
    
    const updates = [];
    
    for (const chapterId of changedChapters) {
        updates.push({
            chapter_id: chapterId,
            title: document.getElementById(`title-${chapterId}`).innerText,
            transformed_text: document.getElementById(`transformed-text-${chapterId}`).value,
            ai_prompt: document.getElementById(`prompt-${chapterId}`).value
        });
    }
    
    try {
        const response = await fetch('/chapters/batch-update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ updates: updates })
        });
        
        if (response.ok) {
            changedChapters.clear();
            btn.innerHTML = '<i class="bi bi-check"></i> Saved!';
            btn.className = 'btn btn-success';
            setTimeout(() => {
                btn.innerHTML = '<i class="bi bi-save"></i> Save All Changes';
                btn.disabled = false;
            }, 2000);
        } else {
            btn.innerHTML = '<i class="bi bi-x"></i> Save Failed';
            btn.className = 'btn btn-danger';
            btn.disabled = false;
        }
    } catch (error) {
        btn.innerHTML = '<i class="bi bi-x"></i> Error';
        btn.className = 'btn btn-danger';
        btn.disabled = false;
    }
}

// Cover page functions
const adaptationId = {{ adaptation.adaptation_id }};

function viewCoverImage() {
    const modalElement = document.getElementById('coverImageModal');
    // Show modal using Bootstrap
    const modal = new bootstrap.Modal(modalElement, {
        keyboard: true,
        backdrop: true
    });
    modal.show();
}

function forceCloseModal() {
    console.log('Force closing modal...');
    const modalElement = document.getElementById('coverImageModal');
    
    // Try Bootstrap method first
    const modal = bootstrap.Modal.getInstance(modalElement);
    if (modal) {
        console.log('Using Bootstrap hide()');
        modal.hide();
    }
    
    // Force close as backup
    setTimeout(() => {
        console.log('Forcing modal closure...');
        modalElement.classList.remove('show');
        modalElement.style.display = 'none';
        modalElement.setAttribute('aria-hidden', 'true');
        modalElement.removeAttribute('aria-modal');
        modalElement.removeAttribute('role');
        
        // Remove all backdrops
        const backdrops = document.querySelectorAll('.modal-backdrop');
        console.log('Found backdrops:', backdrops.length);
        backdrops.forEach(backdrop => backdrop.remove());
        
        // Restore body
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        console.log('Modal force closed');
    }, 100);
}

function editCoverPrompt() {
    // Close any open modals first
    const coverImageModal = bootstrap.Modal.getInstance(document.getElementById('coverImageModal'));
    if (coverImageModal) {
        coverImageModal.hide();
    }
    
    // Load current cover prompt
    const currentPrompt = document.getElementById('coverPromptDisplay').innerText;
    document.getElementById('coverPromptInput').value = currentPrompt === 'No cover prompt set yet.' ? '' : currentPrompt;
    
    // Show edit modal
    const modal = new bootstrap.Modal(document.getElementById('editCoverPromptModal'));
    modal.show();
}

async function saveCoverPrompt() {
    const coverPrompt = document.getElementById('coverPromptInput').value.trim();
    
    if (!coverPrompt) {
        alert('Please enter a cover prompt.');
        return;
    }
    
    // Disable button and show loading
    const saveButton = event.target;
    const originalHTML = saveButton.innerHTML;
    saveButton.disabled = true;
    saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
    
    const formData = new FormData();
    formData.append('cover_prompt', coverPrompt);
    
    try {
        const response = await fetch(`/review/adaptation/${adaptationId}/update-cover-prompt`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update the display
            document.getElementById('coverPromptDisplay').innerText = coverPrompt;
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('editCoverPromptModal')).hide();
            
            alert('Cover prompt saved successfully!');
            location.reload();
        } else {
            alert('Error saving cover prompt: ' + (data.error || 'Unknown error'));
            saveButton.disabled = false;
            saveButton.innerHTML = originalHTML;
        }
    } catch (error) {
        console.error('Error saving cover prompt:', error);
        alert('Error saving cover prompt');
        saveButton.disabled = false;
        saveButton.innerHTML = originalHTML;
    }
}

async function regenerateAICoverPrompt() {
    if (!confirm('Regenerate the cover prompt using AI book analysis? This will analyze the entire book and create a new prompt.')) {
        return;
    }
    
    // Show loading indicator
    const button = event.target;
    const originalHTML = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analyzing book...';
    
    try {
        const response = await fetch(`/review/adaptation/${adaptationId}/generate-cover-prompt`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success && data.cover_prompt) {
            // Update the display
            document.getElementById('coverPromptDisplay').innerText = data.cover_prompt;
            
            alert('AI cover prompt generated successfully! The prompt has been updated based on comprehensive book analysis.');
            location.reload();
        } else {
            alert('Error regenerating cover prompt: ' + (data.error || 'Unknown error'));
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    } catch (error) {
        console.error('Error regenerating cover prompt:', error);
        alert('Error regenerating cover prompt');
        button.disabled = false;
        button.innerHTML = originalHTML;
    }
}

async function generateAICoverPrompt() {
    // Show loading indicator
    const button = document.getElementById('generatePromptBtn');
    const originalHTML = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analyzing book...';
    
    try {
        const response = await fetch(`/review/adaptation/${adaptationId}/generate-cover-prompt`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success && data.cover_prompt) {
            // Update the display
            document.getElementById('coverPromptDisplay').innerText = data.cover_prompt;
            
            // Show success message
            alert('AI cover prompt generated successfully! Review it below and click "Generate Cover Image" when ready.');
            location.reload();
        } else {
            alert('Error generating AI cover prompt: ' + (data.error || data.message || 'Unknown error'));
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    } catch (error) {
        console.error('Error generating AI cover prompt:', error);
        alert('Error generating AI cover prompt. Please try again.');
        button.disabled = false;
        button.innerHTML = originalHTML;
    }
}

async function generateCover() {
    // Check if cover prompt exists
    const promptText = document.getElementById('coverPromptDisplay').innerText.trim();
    
    if (!promptText || promptText === 'No cover prompt set yet.') {
        if (confirm('No cover prompt found. Would you like to generate an AI cover prompt first?')) {
            await generateAICoverPrompt();
            return;
        } else {
            return;
        }
    }
    
    // Check for text instructions in prompt BEFORE generation
    const hasTextInstructions = /title|text|written by|author|typography|font|lettering/i.test(promptText);
    
    if (hasTextInstructions) {
        // Check current backend setting
        try {
            const settingsResponse = await fetch('/settings/api/settings');
            const settings = await settingsResponse.json();
            const currentBackend = settings.default_image_backend || 'gpt-image-1';
            
            if (currentBackend.startsWith('vertex') || currentBackend.startsWith('imagen')) {
                const warningMsg = `⚠️ TEXT RENDERING WARNING\n\nYour cover prompt includes text instructions (title, author, etc.), but you have "${currentBackend}" selected.\n\nImagen models CANNOT render text in images. The title and author text will NOT appear on your cover.\n\nRECOMMENDATIONS:\n• Switch to "GPT-Image-1" in Settings for text rendering\n• Or remove text instructions from your prompt\n• Or continue anyway (text will be missing)\n\nDo you want to continue generating with ${currentBackend}?`;
                
                if (!confirm(warningMsg)) {
                    return; // User cancelled
                }
            }
        } catch (error) {
            console.error('Error checking settings:', error);
            // Continue anyway if we can't check settings
        }
    }
    
    if (!confirm('Generate cover image for this adaptation? This may take a minute.')) {
        return;
    }
    
    // Show loading indicator
    const button = event.target;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
    
    try {
        const response = await fetch(`/review/adaptation/${adaptationId}/generate-cover`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Cover image generated successfully!');
            location.reload();
        } else {
            alert('Error generating cover image: ' + (data.error || 'Unknown error'));
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-magic"></i> Generate Cover Image';
        }
    } catch (error) {
        console.error('Error generating cover:', error);
        alert('Error generating cover image');
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-magic"></i> Generate Cover Image';
    }
}

async function regenerateCover() {
    // Check for text instructions in prompt BEFORE regeneration
    const promptText = document.getElementById('coverPromptDisplay').innerText.trim();
    const hasTextInstructions = /title|text|written by|author|typography|font|lettering/i.test(promptText);
    
    if (hasTextInstructions) {
        // Check current backend setting
        try {
            const settingsResponse = await fetch('/settings/api/settings');
            const settings = await settingsResponse.json();
            const currentBackend = settings.default_image_backend || 'gpt-image-1';
            
            if (currentBackend.startsWith('vertex') || currentBackend.startsWith('imagen')) {
                const warningMsg = `⚠️ TEXT RENDERING WARNING\n\nYour cover prompt includes text instructions (title, author, etc.), but you have "${currentBackend}" selected.\n\nImagen models CANNOT render text in images. The title and author text will NOT appear on your cover.\n\nRECOMMENDATIONS:\n• Switch to "GPT-Image-1" in Settings for text rendering\n• Or remove text instructions from your prompt\n• Or continue anyway (text will be missing)\n\nDo you want to continue regenerating with ${currentBackend}?`;
                
                if (!confirm(warningMsg)) {
                    return; // User cancelled
                }
            }
        } catch (error) {
            console.error('Error checking settings:', error);
            // Continue anyway if we can't check settings
        }
    }
    
    if (!confirm('Regenerate the cover image? This will replace the existing cover.')) {
        return;
    }
    
    // Show loading indicator
    const button = event.target;
    const originalHTML = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Regenerating...';
    
    try {
        const response = await fetch(`/review/adaptation/${adaptationId}/regenerate-cover`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Cover image regenerated successfully!');
            location.reload();
        } else {
            alert('Error regenerating cover image: ' + (data.error || 'Unknown error'));
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    } catch (error) {
        console.error('Error regenerating cover:', error);
        alert('Error regenerating cover image');
        button.disabled = false;
        button.innerHTML = originalHTML;
    }
}

// Ensure modal cleanup on close
document.addEventListener('DOMContentLoaded', function() {
    const coverImageModal = document.getElementById('coverImageModal');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalCoverImage = document.getElementById('modalCoverImage');
    
    if (coverImageModal) {
        // Clean up on hide event
        coverImageModal.addEventListener('hide.bs.modal', function (e) {
            console.log('Modal hiding event...');
        });
        
        coverImageModal.addEventListener('hidden.bs.modal', function (e) {
            console.log('Modal hidden event, cleaning up...');
            // Clean up any leftover backdrops
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            // Restore body scroll
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        });
        
        // Click on modal backdrop to close
        coverImageModal.addEventListener('click', function(e) {
            console.log('Modal clicked, target:', e.target.id, 'classList:', e.target.classList.toString());
            // Close if clicked on modal backdrop (not the dialog content itself)
            if (e.target.id === 'coverImageModal' || e.target.classList.contains('modal-dialog') || e.target.classList.contains('modal-content') || e.target.classList.contains('modal-body')) {
                console.log('Clicked modal backdrop - closing');
                forceCloseModal();
            }
        });
    }
    
    // Click close button
    if (modalCloseBtn) {
        modalCloseBtn.addEventListener('click', function(e) {
            console.log('Close button clicked');
            e.stopPropagation();
            forceCloseModal();
        });
    }
    
    // Click image to close
    if (modalCoverImage) {
        modalCoverImage.addEventListener('click', function(e) {
            console.log('Image clicked');
            e.stopPropagation();
            forceCloseModal();
        });
    }
    
    // Add ESC key handler
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' || e.keyCode === 27) {
            console.log('ESC key pressed');
            const modalElement = document.getElementById('coverImageModal');
            if (modalElement && modalElement.classList.contains('show')) {
                forceCloseModal();
            }
        }
    });
});
</script>


<!-- Cover Prompt Edit Modal -->
<div class="modal fade" id="editCoverPromptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Cover Prompt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCoverPromptForm">
                    <div class="mb-3">
                        <label for="coverPromptInput" class="form-label">Cover Prompt</label>
                        <textarea class="form-control" id="coverPromptInput" name="cover_prompt" rows="6" placeholder="Describe the cover image you want to generate for this book..."></textarea>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> Describe the overall theme, setting, and main characters that should appear on the book cover.
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCoverPrompt()">Save Prompt</button>
            </div>
        </div>
    </div>
</div>

<!-- Cover Image View Modal - Simplified -->
<div id="coverImageModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-body text-center p-2" style="position: relative;">
                {% if adaptation.cover_url %}
                <!-- Close button -->
                <button type="button" id="modalCloseBtn" class="btn btn-light position-absolute" 
                        style="top: 10px; right: 10px; z-index: 1060; opacity: 0.9; width: 50px; height: 50px; border-radius: 50%; font-size: 24px; line-height: 1;"
                        title="Close">
                    ✕
                </button>
                
                <!-- Image - Click to close -->
                <img id="modalCoverImage" src="{{ adaptation.cover_url }}" 
                     class="img-fluid rounded shadow-lg" 
                     alt="Cover Image" 
                     style="max-height: 85vh; max-width: 100%; cursor: pointer;">
                
                <p class="text-white mt-3" style="text-shadow: 0 0 10px rgba(0,0,0,0.8);">
                    Click image or X to close • Press ESC to close
                </p>
                {% else %}
                <p class="text-white">No cover image available</p>
                <button type="button" class="btn btn-secondary" onclick="forceCloseModal()">Close</button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.editable-title {
    border: none;
    background: transparent;
    font-weight: inherit;
    color: inherit;
}

.editable-title:focus {
    outline: 1px dashed #007bff;
    padding: 2px 4px;
    border-radius: 3px;
}

.chapter-text {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
}

.card {
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
}

/* Fix nav tabs in dark mode */
.nav-tabs {
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.nav-tabs .nav-link {
    color: #adb5bd !important;
    background-color: transparent;
    border: 1px solid transparent;
}

.nav-tabs .nav-link:hover {
    color: #ffffff !important;
    border-color: rgba(255, 255, 255, 0.2) rgba(255, 255, 255, 0.2) transparent;
    background-color: rgba(255, 255, 255, 0.05);
}

.nav-tabs .nav-link.active {
    color: #ffffff !important;
    background-color: var(--bs-body-bg) !important;
    border-color: rgba(255, 255, 255, 0.2) rgba(255, 255, 255, 0.2) var(--bs-body-bg);
}

/* Dark mode specific styles */
body.bg-dark .nav-tabs .nav-link {
    color: #adb5bd !important;
}

body.bg-dark .nav-tabs .nav-link:hover {
    color: #ffffff !important;
    background-color: rgba(255, 255, 255, 0.1);
}

body.bg-dark .nav-tabs .nav-link.active {
    color: #ffffff !important;
    background-color: #212529 !important;
    border-color: rgba(255, 255, 255, 0.2) rgba(255, 255, 255, 0.2) #212529;
}

/* Image section card styling */
.image-section-card {
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

body.bg-dark .image-section-card {
    background-color: rgba(0, 0, 0, 0.2);
    border-color: rgba(255, 255, 255, 0.1);
}
</style>
{% endblock %}